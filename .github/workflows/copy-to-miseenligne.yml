name: Copier changes de main vers misenligne

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  copy-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: false  # important : on n'utilise pas GITHUB_TOKEN pour le push

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Ensure miseenligne branch exists locally
        run: |
          # Récupère la branche distante si elle existe, sinon crée localement depuis main
          git fetch origin miseenligne || true
          if git show-ref --verify --quiet refs/remotes/origin/miseenligne; then
            git checkout miseenligne
          else
            git checkout -b miseenligne
          fi

      - name: Copy files from main into miseenligne
        run: |
          # Remplace le contenu de la branche locale miseenligne par le contenu de main
          git checkout main -- .
          git add -A
          # On ne commit que s'il y a des changements
          if ! git diff --cached --quiet; then
            git commit -m "Copie automatique depuis main via GitHub Actions"
          else
            echo "Pas de modifications à copier."
          fi

      - name: Push to miseenligne (using GH_PAT)
        env:
          REPO_URL: https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git
        run: |
          # Configure remote pour utiliser le PAT
          git remote set-url origin "$REPO_URL"
          # Si la branche distante existe, on compare ; sinon on pousse (création de la branche distante)
          if git show-ref --verify --quiet refs/remotes/origin/miseenligne; then
            git fetch origin miseenligne
            if ! git diff --quiet origin/miseenligne..HEAD; then
              git push origin HEAD:miseenligne
            else
              echo "Aucune différence avec origin/miseenligne, pas de push."
            fi
          else
            git push origin HEAD:miseenligne
          fi
